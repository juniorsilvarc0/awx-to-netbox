---
- name: "ğŸš€ AWX Simple Collector - Dados Essenciais para NetBox"
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: "ğŸ” Validar credentials AWX"
      debug:
        msg: |
          ğŸ” ValidaÃ§Ã£o de Credentials:
          ğŸ‘¤ AWX Username: {{ lookup('env', 'AWX_USERNAME') | default('NÃƒO DEFINIDO') }}
          ğŸ”‘ AWX Password: {{ 'DEFINIDO âœ…' if lookup('env', 'AWX_PASSWORD') else 'NÃƒO DEFINIDO âŒ' }}
          ğŸ”— AWX URL: {{ awx_url | default('http://10.0.100.159:8013') }}
      failed_when: not lookup('env', 'AWX_USERNAME') or not lookup('env', 'AWX_PASSWORD')

    - name: "ğŸ” Testar conectividade com AWX"
      uri:
        url: "{{ awx_url | default('http://10.0.100.159:8013') }}/api/v2/"
        method: GET
        user: "{{ lookup('env', 'AWX_USERNAME') }}"
        password: "{{ lookup('env', 'AWX_PASSWORD') }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: awx_connectivity
      failed_when: false

    - name: "âŒ Falhar se nÃ£o conseguir conectar"
      fail:
        msg: "NÃ£o foi possÃ­vel conectar ao AWX. Verifique credenciais."
      when: awx_connectivity.status != 200

    - name: "ğŸ“¦ Buscar inventÃ¡rios disponÃ­veis"
      uri:
        url: "{{ awx_url | default('http://10.0.100.159:8013') }}/api/v2/inventories/"
        method: GET
        user: "{{ lookup('env', 'AWX_USERNAME') }}"
        password: "{{ lookup('env', 'AWX_PASSWORD') }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: awx_inventories

    - name: "ğŸ¯ Filtrar inventÃ¡rios alvo"
      set_fact:
        target_inventories: >-
          {{
            awx_inventories.json.results | 
            selectattr('name', 'in', (inventory_filter | default('VMware Inventory')).split(',') | map('trim')) | 
            list
          }}

    - name: "ğŸ–¥ï¸ Buscar hosts dos inventÃ¡rios selecionados"
      uri:
        url: "{{ awx_url | default('http://10.0.100.159:8013') }}/api/v2/inventories/{{ item.id }}/hosts/"
        method: GET
        user: "{{ lookup('env', 'AWX_USERNAME') }}"
        password: "{{ lookup('env', 'AWX_PASSWORD') }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: inventory_hosts
      loop: "{{ target_inventories }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "ğŸ–¥ï¸ Consolidar lista de hosts"
      set_fact:
        all_hosts: "{{ all_hosts | default([]) + item.json.results }}"
      loop: "{{ inventory_hosts.results }}"

    - name: "ğŸ” Aplicar filtro de hosts"
      set_fact:
        filtered_hosts: >-
          {{
            all_hosts | 
            selectattr('name', 'search', host_filter) | 
            list
          }}
      when: host_filter is defined and host_filter != ""

    - name: "ğŸ” Usar todos os hosts se nÃ£o houver filtro"
      set_fact:
        filtered_hosts: "{{ all_hosts }}"
      when: host_filter is not defined or host_filter == ""

    - name: "ğŸ” Buscar detalhes completos dos hosts"
      uri:
        url: "{{ awx_url | default('http://10.0.100.159:8013') }}/api/v2/hosts/{{ item.id }}/"
        method: GET
        user: "{{ lookup('env', 'AWX_USERNAME') }}"
        password: "{{ lookup('env', 'AWX_PASSWORD') }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: host_details
      loop: "{{ filtered_hosts }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "ğŸ“Š Processar dados essenciais para NetBox"
      set_fact:
        netbox_vms: "{{ netbox_vms | default([]) + [vm_data] }}"
      vars:
        host_detail: "{{ host_details.results[ansible_loop.index0].json }}"
        # Parse seguro das variÃ¡veis
        host_vars: "{{ (host_detail.variables | from_json) if (host_detail.variables and host_detail.variables != '') else {} }}"
        # Dados essenciais para NetBox
        vm_data:
          # IdentificaÃ§Ã£o
          name: "{{ host_detail.name }}"
          description: "{{ host_detail.description | default('Importado do AWX') }}"
          
          # Status (mapear power_state para status NetBox)
          status: "{{ 'active' if (host_vars.vm_power_state | default('')) == 'poweredOn' else 'offline' }}"
          
          # Recursos de Hardware
          vcpus: "{{ host_vars.vm_cpu_count | default(1) | int }}"
          memory_mb: "{{ (host_vars.vm_memory_gb | default(1) | float * 1024) | int }}"
          memory_gb: "{{ host_vars.vm_memory_gb | default(1) | float }}"
          disk_mb: "{{ host_vars.vm_disk_gb | default(host_vars.vm_memory_gb | default(20)) | float * 1024 | int }}"
          disk_gb: "{{ host_vars.vm_disk_gb | default(host_vars.vm_memory_gb | default(20)) | float }}"
          
          # Rede
          primary_ip4: "{{ host_vars.ansible_host | default('') }}"
          ip_addresses: "{{ host_vars.vm_ip_addresses | default([host_vars.ansible_host]) if host_vars.ansible_host else [] }}"
          
          # LocalizaÃ§Ã£o/OrganizaÃ§Ã£o
          cluster: "{{ host_vars.vm_cluster | default('Default Cluster') }}"
          datacenter: "{{ host_vars.vm_datacenter | default('Default Site') }}"
          
          # Sistema
          platform: "{{ host_vars.vm_guest_os | default('Unknown OS') }}"
          
          # Metadata AWX
          awx_id: "{{ host_detail.id }}"
          awx_enabled: "{{ host_detail.enabled }}"
          awx_inventory: "{{ inventory_filter | default('VMware Inventory') }}"
      loop: "{{ filtered_hosts }}"
      loop_control:
        extended: true
        label: "{{ item.name }}"
      failed_when: false

    - name: "ğŸ“‹ Exibir dados coletados (formato NetBox)"
      debug:
        msg: |
          ============================================================
          ğŸ–¥ï¸ VM: {{ item.name }}
          ğŸ“Š Status: {{ item.status | upper }}
          ğŸ’» Hardware:
            - vCPUs: {{ item.vcpus }}
            - MemÃ³ria: {{ item.memory_gb }}GB ({{ item.memory_mb }}MB)
            - Disco: {{ item.disk_gb }}GB ({{ item.disk_mb }}MB)
          ğŸŒ Rede:
            - IP PrimÃ¡rio: {{ item.primary_ip4 if item.primary_ip4 else 'N/A' }}
            - Todos os IPs: {{ item.ip_addresses | join(', ') if item.ip_addresses else 'N/A' }}
          ğŸ¢ LocalizaÃ§Ã£o:
            - Cluster: {{ item.cluster }}
            - Datacenter: {{ item.datacenter }}
          ğŸ’½ Sistema: {{ item.platform }}
          ğŸ”— AWX ID: {{ item.awx_id }}
      loop: "{{ netbox_vms }}"
      when: show_details | default(true)

    - name: "ğŸ“Š Resumo final - Dados para NetBox"
      debug:
        msg: |
          ğŸ“Š Resumo Final - Dados Coletados para NetBox:
          ==========================================
          ğŸ–¥ï¸ Total de VMs processadas: {{ netbox_vms | length }}
          
          ğŸ“‹ VMs por Status:
          {% set active_vms = netbox_vms | selectattr('status', 'equalto', 'active') | list %}
          {% set offline_vms = netbox_vms | selectattr('status', 'equalto', 'offline') | list %}
          - Ativas: {{ active_vms | length }}
          - Offline: {{ offline_vms | length }}
          
          ğŸ’» Recursos Totais:
          - vCPUs Total: {{ netbox_vms | sum(attribute='vcpus') }}
          - MemÃ³ria Total: {{ netbox_vms | sum(attribute='memory_gb') | round(1) }}GB
          - Disco Total: {{ netbox_vms | sum(attribute='disk_gb') | round(1) }}GB
          
          ğŸ¢ Datacenters:
          {% for dc in netbox_vms | map(attribute='datacenter') | unique %}
          - {{ dc }}: {{ netbox_vms | selectattr('datacenter', 'equalto', dc) | list | length }} VMs
          {% endfor %}
          
          âœ… Dados prontos para sincronizaÃ§Ã£o com NetBox!

    - name: "ğŸ’¾ Dados estruturados para NetBox (JSON simulado)"
      debug:
        var: netbox_vms
      when: show_json | default(false)

    - name: "ğŸ¯ PrÃ³ximos passos"
      debug:
        msg: |
          ğŸ¯ PrÃ³ximos Passos para NetBox:
          
          1. âœ… Coleta AWX concluÃ­da - {{ netbox_vms | length }} VMs
          2. ğŸ”„ Configurar NetBox API
          3. ğŸ—ºï¸ Mapear Sites/Clusters no NetBox
          4. ğŸ§ª Testar sincronizaÃ§Ã£o em dry-run
          5. ğŸš€ Executar sincronizaÃ§Ã£o real
          
          ğŸ’¡ Campos coletados (compatÃ­veis com NetBox):
          - Nome, Status, vCPUs, MemÃ³ria, Disco
          - IP PrimÃ¡rio, Platform, Cluster, Site
          - Metadados AWX para rastreamento