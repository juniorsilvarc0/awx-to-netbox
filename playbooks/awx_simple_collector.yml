---
- name: "ğŸš€ AWX Simple Collector - Coleta dados via API AWX"
  hosts: localhost
  gather_facts: false
  vars:
    # ConfiguraÃ§Ãµes AWX (podem ser sobrescritas via extra_vars)
    awx_url: "{{ awx_url | default('http://10.0.100.159:8013') }}"
    # Credentials injetadas via AWX Custom Credential Type
    awx_user: "{{ lookup('env', 'AWX_USERNAME') | default(awx_user | default('junior')) }}"
    awx_password: "{{ lookup('env', 'AWX_PASSWORD') | default(awx_password | default('')) }}"
    
    # Filtros
    inventory_filter: "{{ inventory_filter | default('VMware Inventory') }}"
    host_filter: "{{ host_filter | default('') }}"
    
    # ConfiguraÃ§Ãµes de execuÃ§Ã£o
    list_only: "{{ list_only | default(true) }}"
    show_details: "{{ show_details | default(true) }}"

  tasks:
    - name: "ğŸ” Validar credentials AWX"
      debug:
        msg: |
          ğŸ” ValidaÃ§Ã£o de Credentials:
          ğŸ‘¤ AWX Username: {{ awx_user if awx_user else 'NÃƒO DEFINIDO' }}
          ğŸ”‘ AWX Password: {{ 'DEFINIDO âœ…' if awx_password else 'NÃƒO DEFINIDO âŒ' }}
          ğŸ”— AWX URL: {{ awx_url }}
      failed_when: not awx_user or not awx_password

    - name: "ğŸ“‹ Exibir configuraÃ§Ãµes"
      debug:
        msg: |
          ğŸš€ AWX Simple Collector - ConfiguraÃ§Ãµes:
          ğŸ”— AWX URL: {{ awx_url }}
          ğŸ‘¤ UsuÃ¡rio: {{ awx_user }}
          ğŸ“¦ Filtro de inventÃ¡rios: {{ inventory_filter }}
          ğŸ–¥ï¸ Filtro de hosts: {{ host_filter if host_filter else 'Nenhum' }}
          ğŸ“Š Modo: {{ 'Apenas Listar' if list_only else 'Processar para NetBox' }}
          ğŸ“‹ Mostrar detalhes: {{ 'Sim' if show_details else 'NÃ£o' }}

    - name: "ğŸ” Testar conectividade com AWX"
      uri:
        url: "{{ awx_url }}/api/v2/"
        method: GET
        user: "{{ awx_user }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: awx_connectivity
      failed_when: false

    - name: "âœ… Conectividade AWX"
      debug:
        msg: |
          {% if awx_connectivity.status == 200 %}
          âœ… Conectado com sucesso!
          ğŸ‘¤ UsuÃ¡rio atual: {{ awx_connectivity.json.current_user.username | default('Desconhecido') }}
          ğŸ“Š VersÃ£o AWX: {{ awx_connectivity.json.version | default('Desconhecida') }}
          {% else %}
          âŒ Falha na conectividade!
          ğŸ” Status: {{ awx_connectivity.status | default('N/A') }}
          ğŸ“ Erro: {{ awx_connectivity.msg | default('ConexÃ£o falhou') }}
          {% endif %}

    - name: "âŒ Falhar se nÃ£o conseguir conectar"
      fail:
        msg: "NÃ£o foi possÃ­vel conectar ao AWX. Verifique URL, usuÃ¡rio e senha."
      when: awx_connectivity.status != 200

    - name: "ğŸ“¦ Buscar inventÃ¡rios disponÃ­veis"
      uri:
        url: "{{ awx_url }}/api/v2/inventories/"
        method: GET
        user: "{{ awx_user }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: awx_inventories

    - name: "ğŸ“Š Exibir inventÃ¡rios encontrados"
      debug:
        msg: |
          ğŸ“¦ InventÃ¡rios encontrados ({{ awx_inventories.json.count }}):
          {% for inv in awx_inventories.json.results %}
          - {{ inv.name }} (ID: {{ inv.id }}) - {{ inv.description | default('Sem descriÃ§Ã£o') }}
          {% endfor %}

    - name: "ğŸ¯ Filtrar inventÃ¡rios alvo"
      set_fact:
        target_inventories: >-
          {{
            awx_inventories.json.results | 
            selectattr('name', 'in', inventory_filter.split(',') | map('trim')) | 
            list
          }}
      when: inventory_filter != ""

    - name: "ğŸ¯ Usar todos os inventÃ¡rios se nÃ£o houver filtro"
      set_fact:
        target_inventories: "{{ awx_inventories.json.results }}"
      when: inventory_filter == ""

    - name: "ğŸ“‹ Exibir inventÃ¡rios selecionados"
      debug:
        msg: |
          ğŸ¯ InventÃ¡rios selecionados para processamento:
          {% for inv in target_inventories %}
          - {{ inv.name }} (ID: {{ inv.id }})
          {% endfor %}

    - name: "ğŸ–¥ï¸ Buscar hosts dos inventÃ¡rios selecionados"
      uri:
        url: "{{ awx_url }}/api/v2/inventories/{{ item.id }}/hosts/"
        method: GET
        user: "{{ awx_user }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: inventory_hosts
      loop: "{{ target_inventories }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "ğŸ–¥ï¸ Consolidar lista de hosts"
      set_fact:
        all_hosts: "{{ all_hosts | default([]) + item.json.results }}"
      loop: "{{ inventory_hosts.results }}"
      loop_control:
        label: "InventÃ¡rio com {{ item.json.results | length }} hosts"

    - name: "ğŸ” Aplicar filtro de hosts"
      set_fact:
        filtered_hosts: >-
          {{
            all_hosts | 
            selectattr('name', 'search', host_filter) | 
            list
          }}
      when: host_filter != ""

    - name: "ğŸ” Usar todos os hosts se nÃ£o houver filtro"
      set_fact:
        filtered_hosts: "{{ all_hosts }}"
      when: host_filter == ""

    - name: "ğŸ“Š Exibir resumo dos hosts"
      debug:
        msg: |
          ğŸ–¥ï¸ Resumo dos hosts:
          - Total encontrado: {{ all_hosts | length }}
          - ApÃ³s filtros: {{ filtered_hosts | length }}
          
          ğŸ“‹ Hosts selecionados:
          {% for host in filtered_hosts %}
          - {{ host.name }} (ID: {{ host.id }}) {{ 'ğŸŸ¢' if host.enabled else 'ğŸ”´' }}
          {% endfor %}

    - name: "ğŸ” Buscar detalhes completos dos hosts"
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ item.id }}/"
        method: GET
        user: "{{ awx_user }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: host_details
      loop: "{{ filtered_hosts }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "ğŸ‘¥ Buscar grupos dos hosts"
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ item.id }}/groups/"
        method: GET
        user: "{{ awx_user }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        validate_certs: false
        return_content: true
      register: host_groups
      loop: "{{ filtered_hosts }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "ğŸ“Š Processar e exibir dados detalhados dos hosts"
      debug:
        msg: |
          ============================================================
          ğŸ–¥ï¸ Host: {{ host_detail.name }} (ID: {{ host_detail.id }})
          ğŸ“ DescriÃ§Ã£o: {{ host_detail.description }}
          ğŸ”› Habilitado: {{ 'Sim' if host_detail.enabled else 'NÃ£o' }}
          ğŸ“¡ IP Ansible: {{ (host_detail.variables | from_json).ansible_host | default('N/A') }}
          
          ğŸ–¼ï¸ InformaÃ§Ãµes da VM:
             Nome da VM: {{ (host_detail.variables | from_json).vm_name | default('N/A') }}
             Sistema Operacional: {{ (host_detail.variables | from_json).vm_guest_os | default('N/A') }}
             Estado: {{ (host_detail.variables | from_json).vm_power_state | default('N/A') }}
             CPU: {{ (host_detail.variables | from_json).vm_cpu_count | default('N/A') }}
             MemÃ³ria: {{ (host_detail.variables | from_json).vm_memory_gb | default('N/A') }} GB
             Datacenter: {{ (host_detail.variables | from_json).vm_datacenter | default('N/A') }}
             Cluster: {{ (host_detail.variables | from_json).vm_cluster | default('N/A') }}
             UUID: {{ (host_detail.variables | from_json).vm_uuid | default('N/A') }}
             {% set ip_addresses = (host_detail.variables | from_json).vm_ip_addresses | default([]) %}
             {% if ip_addresses %}
             IPs: {{ ip_addresses | join(', ') }}
             {% endif %}
          
          ğŸ‘¥ Grupos: {{ host_group.results | map(attribute='name') | join(', ') }}
          
          ğŸ”§ Comando para detalhes via API:
          curl -u '{{ awx_user }}:****' '{{ awx_url }}/api/v2/hosts/{{ host_detail.id }}/' | jq '.'
      vars:
        host_detail: "{{ host_details.results[ansible_loop.index0].json }}"
        host_group: "{{ host_groups.results[ansible_loop.index0].json }}"
      loop: "{{ filtered_hosts }}"
      loop_control:
        extended: true
        label: "{{ item.name }}"
      when: show_details | bool

    - name: "ğŸ“Š Resumo final"
      debug:
        msg: |
          ğŸ“Š Resumo Final:
          ==========================================
          ğŸ“¦ InventÃ¡rios processados: {{ target_inventories | length }}
          ğŸ–¥ï¸ Total de hosts encontrados: {{ all_hosts | length }}
          ğŸ¯ Hosts apÃ³s filtros: {{ filtered_hosts | length }}
          ğŸ“‹ Modo de execuÃ§Ã£o: {{ 'Apenas Listagem' if list_only else 'Processamento Completo' }}
          
          âœ… Coleta concluÃ­da com sucesso!
          
          ğŸ”§ Comandos Ãºteis:
          # Listar todos os inventÃ¡rios
          curl -u '{{ awx_user }}:****' '{{ awx_url }}/api/v2/inventories/' | jq '.results[] | {id, name}'
          
          # Hosts de um inventÃ¡rio especÃ­fico
          curl -u '{{ awx_user }}:****' '{{ awx_url }}/api/v2/inventories/INVENTORY_ID/hosts/' | jq '.results[] | {id, name}'

    - name: "ğŸ’¾ Salvar dados coletados (simulado)"
      debug:
        msg: |
          ğŸ’¾ Dados que seriam salvos em arquivo JSON:
          - {{ filtered_hosts | length }} hosts processados
          - Dados incluem: nome, IP, specs da VM, grupos, etc.
          - Em execuÃ§Ã£o real, seria salvo em awx_hosts_data.json
      when: list_only | bool

    - name: "ğŸ¯ PrÃ³ximos passos"
      debug:
        msg: |
          ğŸ¯ PrÃ³ximos Passos:
          
          1. âœ… Coleta AWX funcionando
          2. ğŸ”„ Configurar NetBox (se necessÃ¡rio)
          3. ğŸ§ª Testar sincronizaÃ§Ã£o em dry-run
          4. ğŸš€ Executar sincronizaÃ§Ã£o real
          
          ğŸ’¡ Para processar no NetBox:
          - Configure netbox_url e netbox_token
          - Defina list_only=false nas extra_vars
          - Execute novamente o job