---
- name: Executar sincroniza√ß√£o AWX ‚Üí NetBox via script Python
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Verificar diret√≥rio de trabalho
      ansible.builtin.shell: |
        echo "üìÇ Diret√≥rio atual: $(pwd)"
        echo "üìã Conte√∫do do diret√≥rio:"
        ls -la
        echo ""
        echo "üìÇ Subindo para o diret√≥rio projeto:"
        cd ..
        echo "üìÇ Diret√≥rio projeto: $(pwd)"
        ls -la
        echo ""
        echo "üîç Verificando se script existe:"
        ls -la scripts/awx-netbox.py || echo "‚ùå Script n√£o encontrado!"
        echo ""
        echo "üêç Verificando Python:"
        python3 --version
        echo ""
        echo "üîç Verificando vari√°veis..."
        echo "AWX_USERNAME: ${AWX_USERNAME:-'N√ÉO DEFINIDO'}"
        echo "AWX_PASSWORD: ${AWX_PASSWORD:+'DEFINIDO'}"
        echo "NETBOX_API: ${NETBOX_API:-'N√ÉO DEFINIDO'}"
        echo "NETBOX_TOKEN: ${NETBOX_TOKEN:+'DEFINIDO'}"
      args:
        chdir: "{{ ansible_env.ANSIBLE_PROJECT_DIR | default('.') }}"
      register: debug_result

    - name: Mostrar debug
      debug:
        var: debug_result.stdout_lines

    - name: Executar script Python
      ansible.builtin.shell: |
        echo "üöÄ Executando script Python..."
        cd ..
        python3 -u scripts/awx-netbox.py
      args:
        chdir: "{{ ansible_env.ANSIBLE_PROJECT_DIR | default('.') }}"
      register: script_result
      failed_when: false

    - name: Mostrar resultado do script
      debug:
        msg: |
          Return code: {{ script_result.rc }}
          STDOUT: {{ script_result.stdout }}
          STDERR: {{ script_result.stderr }}
